(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class P{constructor(){this.urlBase=`${window.location.origin}`}async nodeProductService(e){if(e)try{console.log("testtt");const t=await fetch(`${this.urlBase}/get-product-quote/${e}`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!t.ok)throw new Error(`Error HTTP: ${t.status}`);const i=await t.json();return console.log(i),i.product}catch(t){console.error("Error en fetchData:",t)}}async nodeProductService(){if(this.nid)try{const e=await fetch(`${this.urlBase}/get-product-quote/${this.nid}`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!e.ok)throw new Error(`Error HTTP: ${e.status}`);return(await e.json()).product}catch(e){console.error("Error en fetchData:",e)}}async parametersService(){try{const e=await fetch(`${this.urlBase}/get-parameters`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!e.ok)throw new Error(`Error HTTP: ${e.status}`);return(await e.json()).data}catch(e){return console.error("Error en fetchData:",e),!1}}}class M{lines=null;itemsProducts=[];succ=null;fals=null;btnRequests=null;constructor(e=null,t){this.settings=e??[],this.parameters=e.parameters??[],this.app=document.querySelector("#quote-lines"),this.addLine=document.querySelector(".add-line"),this.service=new P,this.products=t,this.init()}init(){this.addLine?.addEventListener("click",()=>{this.setLine({})}),this.rfqs=this.settings.group_companies,this.deliveries=this.settings.deliveries,this.quote_settings=this.settings.quote_settings,this.assessment=this.settings.assessment,this.shipping_method=this.settings.shipping_method,this.container_type=this.settings.container_type,this.container_delivery=this.settings.container_delivery,this.incoterms=this.settings.incoterms,this.margin=this.settings.margin,this.currencies=this.settings.currencies,this.brand_line=this.settings.brand_line,this.succ=document.querySelector(".check-succ"),this.succ.innerHTML='<input type="checkbox" >',this.succ.addEventListener("change",e=>this.manageCheck(e)),this.btnRequests=document.querySelector(".requests-send"),this.btnRequests&&(this.btnRequests.style.display="none")}fieldSelect(e,t){const i=document.createElement("td"),s=document.createElement("select");return e&&Object.assign(s,e),Object.values(t).forEach(n=>{const o=document.createElement("option");o.value=n.tid,o.textContent=n.name,e.value&&n.tid==e.value&&(o.selected=!0),s.appendChild(o)}),e.name=="field_shipping_method[]"&&s.addEventListener("change",n=>this.showContainer(s.closest("tr"),n.target.value)),s.addEventListener("change",n=>this.products.calculate(n.target)),i.appendChild(s),i}tooltipInit(e,t){const i=document.createElement("div");i.className="custom-tooltip",i.textContent=t,i.style.display="none",e.appendChild(i),e.addEventListener("mouseenter",s=>{i.style.left=s.pageX+10+"px",i.style.top=s.pageY+10+"px",i.style.display="block"}),e.addEventListener("mouseleave",()=>{i.style.display="none"}),e.addEventListener("mousemove",s=>{i.style.left=s.pageX+10+"px",i.style.top=s.pageY+10+"px"})}tooltipRemove(e){e.querySelector(".custom-tooltip").remove()}setLine(e){this.app.appendChild(this.line(e)),this.counter()}line(e){console.log(e);const t=document.createElement("tr");t.classList=["line-product"];const i=this.fieldInput({name:"field_check[]",type:"checkbox",value:"1",checked:e.field_check==1});i.classList=["td-check"],t.append(i);const s=this.fieldInput({name:"field_product[]",type:"text",autocomplete:"off",value:e.field_product??""});t.append(s);const n=this.fieldInput({name:"field_cant[]",type:"number",value:e.field_cant??""});t.append(n);const o=this.fieldSelect({name:"field_currency_line[]",value:e.field_currency_line??""},this.currencies);t.append(o);const r=this.fieldInput({name:"field_weight_total[]",type:"number",readOnly:!0,value:e.field_weight_total??""});t.append(r);const a=this.fieldInput({name:"field_total[]",type:"number",readOnly:!0,value:e.field_total??""});t.append(a);const l=this.fieldSelect({name:"field_company[]",value:e.field_company??""},this.rfqs);t.append(l);const d=this.fieldSelect({name:"field_delivery_region[]",value:e.field_delivery_region??""},this.deliveries);t.append(d);const f=this.fieldSelect({name:"field_incoterm[]",value:e.field_incoterm??""},this.incoterms);t.append(f);const u=this.fieldSelect({name:"field_brand[]",value:e.field_brand??""},this.brand_line);t.append(u);const y=this.fieldInput({name:"field_tax[]",type:"number",readOnly:!0,value:e.field_taxs??""});t.append(y);const m=this.fieldInput({name:"field_cost[]",type:"number",readOnly:!0,value:e.field_cost??""});t.append(m);const h=this.fieldInput({name:"field_total_cost[]",type:"number",readOnly:!0,value:e.field_total_cost??""});t.append(h);const g=this.fieldSelect({name:"field_assessment[]",value:e.field_assessment??""},this.assessment);t.append(g);const _=this.fieldSelect({name:"field_margin[]",value:e.field_margin??""},this.margin);t.append(_);const w=this.fieldInput({name:"field_landed_cost[]",type:"number",value:e.field_landed_cost??""});t.append(w);const L=this.fieldSelect({name:"field_shipping_method[]",value:e.field_shipping_method??""},this.shipping_method);t.append(L);const S=this.fieldSelect({name:"field_container_type[]",value:e.field_container_type??"",disabled:!0},this.container_type);S.classList.add("td-mar"),t.append(S);const b=this.fieldInput({name:"field_qty[]",type:"number",value:e.field_qty??"",disabled:!0});b.classList.add("td-mar"),t.append(b);const q=this.fieldSelect({name:"field_container_delivery[]",value:e.field_container_delivery??"",disabled:!0},this.container_delivery);q.classList.add("td-mar"),t.append(q);const E=this.fieldInput({name:"field_unit_sale[]",type:"number",readOnly:!0,value:e.field_unit_sale??""});t.append(E);const C=this.fieldInput({name:"field_total_sale[]",type:"number",readOnly:!0,value:e.field_total_sale??""});t.append(C);const T=this.fieldInput({name:"field_sale_factor[]",type:"number",readOnly:!0,value:e.field_sale_factor??""});t.append(T);const x=this.fieldInput({name:"field_delivery_time[]",type:"number",value:e.field_delivery_time??""});t.append(x);const R=this.fieldInput({name:"field_delivery_time_client[]",type:"number",value:e.field_delivery_time_client??""});t.append(R);const k=this.fieldInput({name:"field_comments[]",type:"text",value:e.field_comments??""});t.append(k),e.field_shipping_method&&e.field_shipping_method==120&&this.showContainer(t,120);const v=document.createElement("td");v.classList=["td-small td-delete"];const p=document.createElement("button");return this.settings.process||v.appendChild(p),p.classList=["btn btn-remove"],p.type="button",p.textContent="üóëÔ∏è",p.addEventListener("click",F=>this.removeLine(F)),t.appendChild(v),e.nid&&(t.dataset.id=e.nid,s.querySelector("input").dataset.nid=e.nid),e.nid&&!this.settings.process&&this.products.calculate(s.querySelector("input")),t}fieldInput(e=null){const t=document.createElement("td"),i=document.createElement("input");if(e&&Object.assign(i,e),t.appendChild(i),e.name=="field_product[]"){const s=document.createElement("div");s.classList=["product-suggestion"];const n=document.createElement("ul");s.appendChild(n),t.classList=["td-product"],t.appendChild(s),i.addEventListener("input",o=>this.autoComplete(o,n)),i.addEventListener("keydown",o=>this.handleKeyboardNavigation(o,n,this.itemsProducts)),i.addEventListener("dblclick",o=>window.open(`/node/${o.target.dataset.nid}/edit`,"_blank"))}return e.type=="number"&&(i.step=.01),e.type=="checkbox"&&i.addEventListener("change",s=>this.requestsShow(s.target)),i.addEventListener("change",s=>this.products.calculate(s.target)),t}requestsShow(e){e.checked?this.btnRequests&&(this.btnRequests.style.display="block"):this.btnRequests&&(this.btnRequests.style.display="none")}async autoComplete(e,t){t.innerHTML="";const i=e.target.value;if(!(i.length<3))try{const s=await fetch(`${this.service.urlBase}/get-product-quote/${i}`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!s.ok)throw new Error(`Error HTTP: ${s.status}`);const n=await s.json();this.renderSuggestions(t,n.products,e.target)}catch(s){console.error("Error en fetchData:",s)}}handleKeyboardNavigation(e,t){const i=e.target;let s=-1;const n=t.querySelectorAll("li");if(!e.repeat&&n.length!==0){switch(t.closest(".product-suggestion").style.display="block",n.forEach((o,r)=>{o.classList.contains("active")&&(s=r)}),e.key){case"ArrowDown":e.preventDefault(),s=(s+1)%n.length;break;case"ArrowUp":e.preventDefault(),s=(s-1+n.length)%n.length;break;case"Enter":if(e.preventDefault(),s>=0&&s<n.length){i.value=n[s].textContent,i.dataset.nid=this.itemsProducts[s].nid;const o=this.products.setLine(this.itemsProducts[s],i.closest("tr").dataset.id);i.closest("tr").dataset.id=this.itemsProducts[s].nid,o.success||(i.value="",i.dataset.nid=""),t.closest(".product-suggestion").style.display="none",t.innerHTML=""}return;default:return}n.forEach(o=>o.classList.remove("active")),n[s].classList.add("active")}}renderSuggestions(e,t,i){this.itemsProducts=t,!(!t||t.length===0)&&(e.closest(".product-suggestion").style.display="block",t.forEach(s=>{const n=document.createElement("li");n.textContent=s.name,n.classList.add("suggestion-item"),n.addEventListener("click",()=>{i.value=s.name,i.dataset.nid=s.nid;const o=this.products.setLine(s,i.closest("tr").dataset.id);i.closest("tr").dataset.id=s.nid,o.success||(i.value="",i.dataset.nid=""),e.innerHTML="",e.closest(".product-suggestion").style.display="none"}),e.appendChild(n)}))}removeLine(e){if(!confirm("¬øEst√° segur@ de eliminar esta l√≠ena?"))return;const t=e.target.closest("tr");this.products.lines=this.products.lines.filter(i=>i.nid!=t.dataset.id),t.remove(),this.counter()}modalMarkup(e){if(!this.form.querySelector("#modal-quote")){const t=document.createElement("div");t.classList.add("overlay-modal"),t.id="modal-quote",t.innerHTML=`
            <div class="content-modal">
            <iframe
                class="modal-iframe"
                src="${e}"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; picture-in-picture"
                allowfullscreen
                title="Producto embebido">
            </iframe>
            </div>`,this.form.appendChild(t)}}linkProduct(e,t,i){if(!t.querySelector(".show-product")){const s=document.createElement("a");s.classList.add("show-product"),s.setAttribute("target","_blank"),s.setAttribute("data-nid",e),s.textContent="+",s.href=`/node/${e}/edit`;const n=t.querySelector(".field--name-field-product"),o=n.closest(".paragraphs-subform");o&&(o.setAttribute("data-currency",i),o.setAttribute("data-node",e)),n.prepend(s)}}showModal(e){const t=e.getAttribute("data-nid");t&&this.modalMarkup(`/node/${t}/edit`)}showContainer(e,t){const i=e.querySelector('[name*="field_container_type"]'),s=e.querySelector('[name*="field_container_delivery"]'),n=e.querySelector('[name*="field_qty"]');i.disabled=!0,s.disabled=!0,n.disabled=!0,t==120?(i.disabled=!1,s.disabled=!1,n.disabled=!1):(i.value="",s.value="",n.value="")}succesWarning(e){Object.values(this.settings).forEach(t=>{e.querySelector(`.valid-${t.nid}`)&&e.querySelector(`.valid-${t.nid}`).closest(".paragraph-type--items").classList.add(t.class)})}validateProduct(e,t,i){const s=e.querySelector(".show-product").getAttribute("data-nid"),n=this.settings.findIndex(r=>r.nid===s);let o="product-warning";e.classList.contains("product-success")&&e.classList.remove("product-success"),e.classList.contains("product-warning")&&(e.classList.remove("product-warning"),o="product-success"),t?(e.classList.add("product-success"),o="product-success"):(e.classList.add("product-warning"),o="product-warning"),n!==-1?this.settings[n].class=o:this.settings.push({nid:s,class:o,currency:{tid:i.currency,cost:0}})}parametersMarkup(e){const t=document.querySelector(".quote-parameters");if(t){let i="";const s=document.querySelectorAll("[data-currency]"),n=[];s.forEach(o=>{const r=o.querySelector('[name*="field_total"]');n.push({nid:o.getAttribute("data-node"),currency:o.getAttribute("data-currency"),costTotal:r.value});const a=this.parameters.find(l=>l.tid==o.getAttribute("data-currency"));a&&(r.previousElementSibling.textContent=`Total (${a.name})`)}),this.settings=this.settings.map(o=>({...o,currency:{...o.currency,cost:0}})),Object.values(this.parameters).forEach(o=>{if(this.settings.find(a=>a.currency.tid==o.tid)!=null){const a=n.reduce((l,d)=>d.currency==o.tid?l+parseFloat(d.costTotal):l,0);i+=`<p class="span-left"><small>(${o.factor})</small> <b>${o.name}</b></p>
                        <p class="span-${o.name}">
                            ${parseFloat(a)}
                        </p>
                    `}}),t.innerHTML=`<div class="parameters-body">

                        <div class="bar-left">
                            <div class="total-trm">${i}</div>
                            <div class="quote-parameters--totals">
                                <div class="total-quote">
                                    <p class="span-left"><b>TOTAL COSTO: </b></p><p class="span-right">${e.totals.cost??0} USD</p>
                                </div>
                                <div class="total-quote">
                                    <p class="span-left"><b>PESO TOTAL: </b></p><p class="span-right">${e.totals.weight??0} kg</p>
                                </div>
                                <div class="total-quote">
                                    <p class="span-left"><b>TOTAL COTIZADO: </b></p><p class="span-right">${e.totals.total??0} USD</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    `}}collapseBar(e){e.classList.contains("collapse")?e.classList.remove("collapse"):e.classList.add("collapse")}showError(e,t){e.classList.contains("error-quote--content")||(e.classList.add("error-quote--content"),this.tooltipInit(e,t))}counter(){this.app.querySelectorAll(".td-check .count-line").forEach(i=>{i.remove()}),this.app.querySelectorAll(".td-check").forEach((i,s)=>{const n=document.createElement("span");n.classList=["count-line"],i.closest("tr").dataset.num=s+1,n.textContent=s+1,i.prepend(n)})}manageCheck(e){const t=e.target.checked;this.requestsShow(e.target);const i=this.app.querySelectorAll('input[type="checkbox"]');i.length<1||i.forEach(s=>{s.checked=t})}incotermsMatriz(e,t){const i=e.querySelector('[name*="field_assessment"]'),s=e.querySelector('[name*="field_shipping_method"]');if(!(!i&&!s)){switch(t=t.toLowerCase(),i.disabled=!1,s.disabled=!1,t){case"exwexw":case"fobfob":case"cifcif":case"dapdap":case"ddpddp":i.value=0,s.value="",i.disabled=!0,s.disabled=!0;break;case"fobexw":case"ciffob":case"cifexw":case"dapexw":case"dapcif":case"dapfob":i.disabled=!0;break}this.showContainer(e,s.value)}}}class I{constructor(e,t,i,s){this.containerRow=e,this.dataProduct=null,this.parametersQuote=i.taxes,this.nid=t,this.shipping=i.shipping,this.customs=i.container_delivery,this.formQuote=s,this.ui=this.formQuote.ui}weightTotal(){const e=this.containerRow.querySelector('[name*="field_cant"]'),t=this.containerRow.querySelector('[name*="field_weight_total"]');e&&e.value!=""&&this.dataProduct.weight?t.value=parseFloat(this.dataProduct.weight)*parseFloat(e.value):t.value=0}costTotal(){const e=this.containerRow.querySelector('[name*="field_cant"]'),t=this.containerRow.querySelector('[name*="field_total"]');e.value!=""&&this.dataProduct.cost_unit!=null?(t.value=parseFloat(this.dataProduct.cost_unit)*parseFloat(e.value),this.formQuote.lines.find(i=>i.nid==this.nid)):t.value=0}taxCalculate(){const e=this.containerRow.querySelector('[name*="field_company"]'),t=this.containerRow.querySelector('[name*="field_delivery_region"]');if(this.containerRow.querySelector('[name*="field_tax"]').value=0,e&&t&&e.value>0&&t.value>0&&this.parametersQuote){const i=this.parametersQuote.find(s=>s.rfq===e.value&&s.region===t.value);i&&(this.containerRow.querySelector('[name*="field_tax"]').value=i.tax)}}vrCosttUsd(){let e=this.dataProduct.cost_unit??0;const t=this.getTrm();if(t==null)return;if(e>0){e=parseFloat(e/t.factor);const s=this.containerRow.querySelector('[name*="field_tax"]');s&&s.value!=""&&(e=e*(1+s.value/100))}this.containerRow.querySelector('[name*="field_cost"]').value=e.toFixed(2);const i=this.containerRow.querySelector('[name*="field_cant"]');if(i&&i.value!=""){const s=this.containerRow.querySelector('[name*="field_total_cost"]');this.containerRow.querySelector('[name*="field_total"]'),s.value=parseFloat(e*i.value).toFixed(2)}}landedCostFactor(){const e=this.containerRow.querySelector('[name*="field_cost"]'),t=this.containerRow.querySelector('[name*="field_assessment"]'),i=this.containerRow.querySelector('[name*="field_landed_cost"]');let s=0;if(i.value=0,e&&e.value>0){const n=this.getShipping();if(console.log("shipp",n),n!=null&&n.hasOwnProperty("type_delivery")){if(n.type_delivery=="aer"){let o=0;t&&t.value!=""&&(o=t.options[t.selectedIndex],o=o.textContent),s=this.dataProduct.weight*n.cost,s=parseFloat(e.value)+parseFloat(s),s=s*((1+parseFloat(o)/100)/e.value),i&&(i.value=s.toFixed(2))}else n.type_delivery=="loc"&&(s=1+parseFloat(n.cost)/100,i.value=s.toFixed(2)),n.type_delivery=="mar"&&(s=parseFloat(n.cost),i.value=s.toFixed(2));n.type_delivery=="defa"&&(i.value=1)}}}getTrm(){return this.ui.parameters.find(e=>e.tid==parseInt(this.dataProduct.currency))}getShipping(){this.containerRow.classList.contains("error-quote--content")&&(this.containerRow.classList.remove("error-quote--content"),this.ui.tooltipRemove(this.containerRow));let e={type_delivery:"defa"};const t=this.containerRow.querySelector('[name*="field_delivery_region"]'),i=this.containerRow.querySelector('[name*="field_shipping_method"]');if(t&&i&&t.value>0&&i.value>0&&(e=this.shipping.find(s=>s.origin==t.value&&s.shipping_method==i.value)),e==null&&(e={type_delivery:"defa",cost:0}),t&&i&&t.value>0&&e!=null&&e.hasOwnProperty("type_delivery")&&e.type_delivery=="mar"){const s=this.containerRow.querySelector('[name*="field_container_type"]'),n=this.containerRow.querySelector('[name*="field_container_delivery"]'),o=this.containerRow.querySelector('[name*="field_qty"]'),r=this.shipping.find(a=>a.dimension==s.value&&a.origin==t.value&&a.shipping_method==i.value);if(e={cost:0,type_delivery:"mar"},s.value>0&&n.value>0&&o&&o.value!=""){const a=this.containerRow.querySelector('[name*="field_total_cost"]'),l=this.containerRow.querySelector('[name*="field_assessment"]');if(a&&r!=null){let d=0;l&&!l.disabled&&(d=l.options[l.selectedIndex],d=d.textContent);const f=r.cost*o.value,u=parseFloat(a.value)+parseFloat(f),y=u*(parseFloat(d)/100),m=this.customs.find(h=>h.tid==parseInt(n.value));if(m){const h=u*(r.customs/100);e={cost:(f*(parseFloat(m.shipping_method)/100)+h+y+u)/parseFloat(a.value),type_delivery:"mar"}}}else this.ui.showError(this.containerRow,"La informaci√≥n del contenedor no est√° completa")}else this.ui.showError(this.containerRow,"La informaci√≥n del contenedor no est√° completa")}return e}vrUnitUsd(){const e=this.containerRow.querySelector('[name*="field_cant"]'),t=this.containerRow.querySelector('[name*="field_landed_cost"]'),i=this.containerRow.querySelector('[name*="field_cost"]'),s=this.containerRow.querySelector('[name*="field_unit_sale"]'),n=this.containerRow.querySelector('[name*="field_total_sale"]'),o=this.containerRow.querySelector('[name*="field_sale_factor"]'),r=this.containerRow.querySelector('[name*="field_margin"]');let a=0;r&&(a=r.options[r.selectedIndex]);let l=0;t&&i&&(l=parseFloat(t.value)*parseFloat(i.value)/(1-parseFloat(a.textContent)/100)),s.value=l.toFixed(2),n.value=(parseFloat(e.value)*l).toFixed(2),o.value=(parseFloat(l)/parseFloat(i.value)).toFixed(2)}async handleGetProduct(){this.dataProduct=await this.services.nodeProductService();const e=this.containerRow.querySelector(".show-product");e?e.href=`/node/${this.nid}/edit`:this.ui.linkProduct(this.nid,this.containerRow,this.dataProduct.currency),this.validState()}updateSettings(e){const t=e.querySelectorAll("[data-nid]");let i=[];t&&t.forEach(n=>{i.push(n.getAttribute("data-nid"))});const s=this.ui.quote_settings.filter(n=>i.includes(n.nid));return this.ui.quote_settings=s,this.ui.parametersMarkup(this.formQuote.totalResults()),this.ui.quote_settings}process(){this.containerRow&&this.nid&&(this.costTotal(),this.weightTotal(),this.taxCalculate(),this.vrCosttUsd(),this.landedCostFactor(),this.vrUnitUsd())}validState(){const e=this.containerRow.closest(".paragraph-type--items");this.dataProduct.weight>0&&this.dataProduct.cost_unit>0?this.ui.validateProduct(e,!0,this.dataProduct):this.ui.validateProduct(e,!1,this.dataProduct)}}class O{lines=[];form=null;ui=null;settings=[];calc=null;constructor(e=null,t=null){this.form=e,this.settings=t,this.ui=new M(t,this),this.calc=new I(null,null,t,this),this.initLines(),this.init()}init(){this.form=document.querySelector("form"),this.form.addEventListener("submit",e=>this.formSubmit(e))}totalResults(){const e={totals:{cost:0,total:0,weight:0},terms:[]},t=document.querySelectorAll('[name*="field_weight_total"]'),i=document.querySelectorAll('[name*="field_total_cost"]'),s=document.querySelectorAll('[name*="field_total_sale"]');return e.totals.weight=this.getTotalField(t).toFixed(2),e.totals.cost=this.getTotalField(i).toFixed(2),e.totals.total=this.getTotalField(s).toFixed(2),e}getTotalField(e){let t=0;return e.length>0&&e.forEach(i=>{i.value&&i.value>0&&(t=t+parseFloat(i.value))}),t}getObjLine(e){return this.lines.find(t=>t.nid==e)}incoterms(e){const t=document.querySelector('[name*="field_incoterms"]'),i=e.querySelector('[name*="field_incoterm"]');this.ui.incotermsMatriz(e,this.getTextSelect(t)+this.getTextSelect(i))}getTextSelect(e){const t=e.selectedIndex;return e.options[t].textContent}calculate(e){if(this.settings.process)return;let t={};const i=e.closest("tr");this.incoterms(i);const s=e.name.replace("[]","");t[s]=e.value,t.nid=i.dataset.id,this.setLine(t),this.calc.containerRow=i,this.calc.nid=i.dataset.id,this.calc.dataProduct=this.getObjLine(this.calc.nid),this.calc.dataProduct.currency=i.querySelector('[name*="field_currency_line"]').value,this.calc.process(),t=this.instanceField(i),t.nid=i.dataset.id,this.setLine(t)}instanceField(e){const t=e.querySelectorAll('input[name*="field_"] , select[name*="field_"]');let i={};return t.forEach(s=>{s.name=="field_check[]"?i.field_check=s.checked?1:0:i[s.name.replace("[]","")]=s.value}),i}initLines(){this.settings.items.length>0&&(this.lines=this.settings.items,Object.values(this.lines).forEach(e=>{this.ui.setLine(e)}))}setLine(e,t=null){if(this.lines.length>0){if(e.nid==null)return;t!=null&&e.nid!=t&&(this.lines=this.lines.filter(s=>s.nid!==t));const i=this.lines.find(s=>s.nid===e.nid);if(i)return Object.assign(i,e),{msg:"L√≠nea de producto actualizada",success:!0}}return this.lines.push(e),{msg:"Nueva l√≠nea de producto agregada",success:!0}}async formSubmit(e){e.preventDefault();const t=e.submitter,i=e.target;if(!t){console.error("No se detect√≥ el bot√≥n de acci√≥n. Fallo al intentar guardar.");return}try{await this.sendLines();const s=document.createElement("input");s.type="hidden",s.name=t.name,s.value=t.value,t.id&&(s.id=t.id),i.appendChild(s),i.submit()}catch(s){console.error("Fallo al guardar las l√≠neas con Fetch. El guardado del nodo ha sido cancelado.",s)}}async sendLines(){if(!this.settings.process)try{const e=await fetch(`/save-lines/${this.settings.nid}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.lines)});if(!e.ok){const i=await e.json().catch(()=>({message:"Error desconocido del servidor."}));throw new Error(`Error HTTP ${e.status}: ${i.message||"Fallo al guardar las l√≠neas."}`)}const t=await e.json();return console.log("L√≠neas guardadas exitosamente. IDs recibidos:",t),t}catch(e){throw console.error("Error al guardar las l√≠neas de cotizaci√≥n:",e),e}}}class ${constructor(e){this.container=e}init(){if(this.container){const e=this.container.querySelector(".quote-modal--body"),t=this.container.querySelector(".quote-modal--head");t.innerHTML='<strong>Enviar solicitudes</strong><span class="modal-head--close"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill="#000" d="M195.2 195.2a64 64 0 0 1 90.496 0L512 421.504 738.304 195.2a64 64 0 0 1 90.496 90.496L602.496 512 828.8 738.304a64 64 0 0 1-90.496 90.496L512 602.496 285.696 828.8a64 64 0 0 1-90.496-90.496L421.504 512 195.2 285.696a64 64 0 0 1 0-90.496z"></path></g></svg></span>';const i=document.createElement("div");i.classList=["quote-modal--form"],i.innerHTML='<div class="form"></div>',e.appendChild(i);const s=document.createElement("div");s.classList=["quote-modal--button"],s.innerHTML='<div class="msg-modal"></div><br><button class="modal-button" type="button">Confirmar env√≠o</button>',e.appendChild(s)}}showModal(){this.container.classList.contains("quote-hide")&&this.container.classList.remove("quote-hide")}hideModal(){this.container.classList.contains("quote-hide")||this.container.classList.add("quote-hide")}}class A{constructor(e,t){this.container=e,this.data=t,this.selected=[],this.render()}render(){this.container.innerHTML=`
        <div class="selected-items"></div>
        <input type="text" class="autocomplete-input" placeholder="Buscar proveedor...">
        <ul class="suggestions"></ul>
        `,this.input=this.container.querySelector(".autocomplete-input"),this.suggestions=this.container.querySelector(".suggestions"),this.selectedContainer=this.container.querySelector(".selected-items"),this.input.addEventListener("input",e=>this.updateSuggestions(e))}updateSuggestions(e){const t=e.target.value.toLowerCase();if(this.suggestions.innerHTML="",!t)return;this.data.filter(s=>s.title.toLowerCase().includes(t)&&s.mail!=null).forEach(s=>{const n=document.createElement("li");n.textContent=s.title,n.onclick=()=>this.addItem(s),this.suggestions.appendChild(n)})}addItem(e){this.selected.includes(e)||(this.selected.push(e),this.renderSelected(),this.input.value="",this.suggestions.innerHTML="")}renderSelected(){this.selectedContainer.innerHTML=this.selected.map(e=>`<span class="tag">${e.title} <button data-item="${e.title}">&times;</button></span>`).join(""),this.selectedContainer.querySelectorAll("button").forEach(e=>{e.onclick=()=>this.removeItem(e.dataset.item)})}removeItem(e){this.selected=this.selected.filter(t=>t.title!==e),this.renderSelected()}getSelected(){return this.selected}reset(){this.selected=[],this.selectedContainer.innerHTML=""}}class j{constructor(e){this.urlBase=`${window.location.origin}`,this.url=e}async send(e){try{return await(await fetch(this.urlBase+this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}catch(t){throw console.error("MailSender:",t),t}}}class H{products=[];constructor(e,t,i){this.providers=t,this.modal=new $(e),this.modal.init(),this.ui=new A(e.querySelector(".form"),t),this.service=new j("/send-request"),this.buttonSubmit(),this.init(),this.path=i.currentPath,this.msg=document.querySelector(".msg-modal")}init(){const e=document.querySelector(".modal-head--close");document.querySelector(".requests-send")?.addEventListener("click",()=>{this.validateSelected()&&this.modal.showModal()}),e?.addEventListener("click",()=>{this.ui.reset(),this.msg.innerHTML="",this.modal.hideModal()})}buttonSubmit(){document.querySelector(".modal-button")?.addEventListener("click",async t=>{if(this.validateSelected()&&this.products.length>0&&confirm("¬øEsta segur@ de enviar las solicitudes?")){const s=document.querySelector(".loader-overlay");s&&(s.style.display="flex");const n={node:this.extractNumberFromPath(),providers:this.ui.getSelected(),products:this.products},o=await this.service.send(n);this.msg&&(this.msg.innerHTML=`<p>${o.msg}</p>`,setTimeout(()=>{this.clearChecks(),this.modal.hideModal(),this.msg.innerHTML=""},2e3)),s&&(s.style.display="none")}})}validateSelected(){return this.getProducts(),this.products.length<1?(alert("No hay productos seleccionados"),!1):!0}getProducts(){return this.products=[],document.querySelectorAll('#quote-lines input[type="checkbox"]').forEach(t=>{const i=t.closest("tr");t.checked&&i.querySelector('input[name*="field_product"]').value!=""&&i.dataset.id!=""&&this.products.push({nid:i.dataset.id,cant:i.querySelector('input[name*="field_cant"]').value})}),this.products}clearChecks(){document.querySelectorAll('#quote-lines input[type="checkbox"]').forEach(t=>{t.checked&&(t.checked=!1)})}extractNumberFromPath(){const e=this.path.match(/(\d+)/);return e?parseInt(e[1],10):null}}(function(c,e,t){e.behaviors.Quote={attach:function(i,s){if(i){const n=document.querySelector("#field-trm-s-values tbody");n&&n.classList.add("tbody-flex")}if(s.process==-1){const n=document.querySelector(".quote-app");n&&(n.innerHTML='<div class="msg-draft"><h3>La cotizaci√≥n debe ser creada para crear o editar l√≠neas...</h3></div>');return}t("quote-form",".quote-app",i).forEach(n=>{new O(n,s)}),t("quote-behavior",".quote-modal",i).forEach(function(n){new H(n,s.providers_list,s.path)})}}})(jQuery,Drupal,once);
